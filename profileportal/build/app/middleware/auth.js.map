{"version":3,"file":"auth.js","names":["_jsonwebtoken","_interopRequireDefault","require","env","concat","process","NODE_ENV","JWT_SECRET","authenticate","exports","req","res","next","token","headers","authorization","replace","jwt","verify","err","decoded","json","success","message","status","send","checkUserPermission","_ref","_asyncToGenerator2","_regenerator","mark","_callee","decode","permission","user","modifiedUrl","commentIdIndex","foundCommentById","wrap","_callee$","_context","prev","Set","username","abrupt","originalUrl","split","lastIndexOf","substring","has","method","appointmentDb","comments","findOne","where","id","params","commentId","sent","comment_name","t0","console","log","stop","_x","_x2","_x3","apply","arguments"],"sources":["../../../src/app/middleware/auth.js"],"sourcesContent":["require(\"custom-env\").env(`${process.env.NODE_ENV}`);\nimport jwt from 'jsonwebtoken';\nconst JWT_SECRET = process.env.JWT_SECRET;\n\nexport const authenticate = ( req, res, next ) => {\n    var token = req.headers.authorization.replace( 'Bearer ', '')\n    if (token) {\n        jwt.verify(token, JWT_SECRET, function (err, decoded) {\n            if ( err ) {\n                return res.json({ success: false, message: 'Failed to authenticate token.' })\n            } else {\n                req.decoded = decoded\n                next()\n            }\n        })\n    } else {\n        return res.status(403).send({\n            success: false,\n            message: 'No token provided.'\n        })\n    }\n}\n\nexport const checkUserPermission = async ( req, res, next ) => {\n    try {\n        const decode = req.decoded\n        const permission = new Set(['PUT:/profileportal/v1/appointments/comments', 'DELETE:/profileportal/v1/appointments/comments']);\n        const user = decode.username;\n        if (!user) {\n            return res.status(403).send({ message: \"You are not allowed to update this comment\" });\n        }\n        \n        let modifiedUrl = req.originalUrl.split( '?' )[0];\n        const commentIdIndex = modifiedUrl.lastIndexOf('/');\n        modifiedUrl = modifiedUrl.substring(0, commentIdIndex);\n        \n        // console.log(`${req.method}:${modifiedUrl}`);\n        if (permission.has(`${req.method}:${modifiedUrl}`)) {\n            let foundCommentById = await appointmentDb.comments.findOne({ where: { id: req.params.commentId } });\n            if (!foundCommentById) {\n                return res.status(404).send({ message: \"Comment not found\" });\n            }\n            if (foundCommentById.comment_name !== user) {\n                return res.status(403).send({ message: \"You are not allowed to update this comment\" });\n            }\n        }\n    } catch (error) {\n        console.log(error)\n        return res.status(500).send({ message: \"Internal server error\" });\n    }\n    next()\n}\n"],"mappings":"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"}